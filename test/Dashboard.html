<html> 
<head> 
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1"> 
<title>Proberequest, TinyMQTT, Websockets, Asyncwebserver, LittleFS Editor & uPlot</title> 
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uplot@1.6.7/dist/uPlot.min.css">

<style>
body {margin: 0;}
.u-legend.u-inline .u-value {width: 150px;text-align: left;}
		
#container { width: 100%; height: 49vh; background-color: #333; display: flex; align-items: center; justify-content: center; overflow: hidden; border-radius: 7px; touch-action: none; } 
#item { width: 100px; height: 100px; background-color: rgb(245, 230, 99); border: 10px solid rgba(136, 136, 136, .5); border-radius: 50%; touch-action: none; user-select: none; } 
#item:active { background-color: rgba(168, 218, 220, 1.00); } 
#item:hover { cursor: pointer; border-width: 20px; } 
#area { position: fixed; right: 33.33%; top: 50vh; } 
#stream-container{ height: 49vh; padding:0; margin:0; margin-block-start:0; margin-block-end:0; margin-inline-start:0; margin-inline-end:0 } 
#stream-container img{ display:block; max-width:100%; min-height:49vh; border-radius:4px; margin-top:8px } 
</style> 

</head> 

<body>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/uplot@1.6.7/dist/uPlot.iife.min.js"></script>

<h2>Proberequest, TinyMQTT, Websockets, Asyncwebserver, LittleFS Editor & uPlot</h2>

<form action="">
  
<SELECT class="combine" id ="command" name = "a">
    <option></option>
    <option>SELECT</option>
    <option>Digital Write</option>
    <option>Analog Write</option>
    <option>Digital Read</option>
    <option>Analog Read</option>
    <option>Neopixel</option>
    <option>Set AP Channel</option>
    <option>Set Sleep Time</option>
    <option>Set Mode</option>
</SELECT>

<SELECT class="combine" id ="device" name = "b">
    <option></option>
    <option>Livingroom</option>
    <option>Kitchen</option>
    <option>Bedroom1</option>
    <option>Bedroom2</option>
    <option>Bathroom1</option>
    <option>Bathroom2</option>
    <option>Laundry</option>
    <option>Office</option>
    
</SELECT>

<SELECT class="combine" id ="command1" name = "c" >
    <option>00</option>
    <option>01</option>
    <option>02</option>
    <option>03</option>
    <option>04</option>
    <option>05</option>
    <option>06</option>
    <option>12</option>
    <option>13</option>
    <option>14</option>
    <option>15</option>
    <option>16</option>
    <option>26</option>
    <option>36</option>
    <option>46</option>
    <option>56</option>
    <option>66</option>
    <option>76</option>
    <option>86</option>
    <option>96</option>
    <option>106</option>
    <option>116</option>
    <option>126</option>
    <option>136</option>
    <option>146</option>
    <option>156</option>
    <option>166</option>
    <option>176</option>
    <option>186</option>
    <option>196</option>
    <option>206</option>
    <option>216</option>
    <option>226</option>
    <option>236</option>
    <option>246</option>
    <option>256</option>
    
</SELECT>

<SELECT class="combine" id ="command2" name = "d">
    <option>00</option>
    <option>01</option>
    <option>02</option>
    <option>03</option>
    <option>04</option>
    <option>05</option>
    <option>06</option>
    <option>12</option>
    <option>13</option>
    <option>14</option>
    <option>15</option>
    <option>16</option>
    <option>26</option>
    <option>36</option>
    <option>46</option>
    <option>56</option>
    <option>66</option>
    <option>76</option>
    <option>86</option>
    <option>96</option>
    <option>106</option>
    <option>116</option>
    <option>126</option>
    <option>136</option>
    <option>146</option>
    <option>156</option>
    <option>166</option>
    <option>176</option>
    <option>186</option>
    <option>196</option>
    <option>206</option>
    <option>216</option>
    <option>226</option>
    <option>236</option>
    <option>246</option>
    <option>256</option>
</SELECT>

<SELECT class="combine" id ="command3" name = "e">
    <option>00</option>
    <option>01</option>
    <option>02</option>
    <option>03</option>
    <option>04</option>
    <option>05</option>
    <option>06</option>
    <option>12</option>
    <option>13</option>
    <option>14</option>
    <option>15</option>
    <option>16</option>
    <option>26</option>
    <option>36</option>
    <option>46</option>
    <option>56</option>
    <option>66</option>
    <option>76</option>
    <option>86</option>
    <option>96</option>
    <option>106</option>
    <option>116</option>
    <option>126</option>
    <option>136</option>
    <option>146</option>
    <option>156</option>
    <option>166</option>
    <option>176</option>
    <option>186</option>
    <option>196</option>
    <option>206</option>
    <option>216</option>
    <option>226</option>
    <option>236</option>
    <option>246</option>
    <option>256</option>
</SELECT>

<SELECT class="combine" id ="command4" name = "f" >
    <option>00</option>
    <option>01</option>
    <option>02</option>
    <option>03</option>
    <option>04</option>
    <option>05</option>
    <option>06</option>
    <option>12</option>
    <option>13</option>
    <option>14</option>
    <option>15</option>
    <option>16</option>
    <option>26</option>
    <option>36</option>
    <option>46</option>
    <option>56</option>
    <option>66</option>
    <option>76</option>
    <option>86</option>
    <option>96</option>
    <option>106</option>
    <option>116</option>
    <option>126</option>
    <option>136</option>
    <option>146</option>
    <option>156</option>
    <option>166</option>
    <option>176</option>
    <option>186</option>
    <option>196</option>
    <option>206</option>
    <option>216</option>
    <option>226</option>
    <option>236</option>
    <option>246</option>
    <option>256</option>
</SELECT>

<SELECT class="combine" id ="column" name = "g">
    <option>*</option>
	<option>Location</option>
    <option>Date</option>
    <option>Day</option>
    <option>Time</option>
    <option>Hour</option>
</SELECT>

<SELECT class="combine" id ="field" name = "h">
    
    <option>Location</option>
    <option>Date</option>
    <option>Day</option>
    <option>Time</option>
    <option>Hour</option>
</SELECT>

<SELECT class="combine" id ="operator" name = "i">
    <option>=</option>
    <option>!=</option>
    <option>></option>
    <option><</option>
    <option><=</option>
    <option>>=</option>
    <option><></option>
</SELECT>
<br>

<script>
var attachEvent = function(node, event, listener, useCapture) {
  // Method for FF, Opera, Chrome, Safari
  if ( window.addEventListener ) {
    node.addEventListener(event, listener, useCapture || false);
  }
  // IE has its own method
  else {
    node.attachEvent('on'+event, listener);
  }
};

// Once the window loads and the DOM is ready, attach the event to the main
  attachEvent(window, "load", function() {
  var select_command = document.getElementById("command");

  var selectHandler = function() {
      option1 = document.getElementById("device"),
      option2 = document.getElementById("command1");
      option3 = document.getElementById("command2");
      option4 = document.getElementById("command3");
      option5 = document.getElementById("command4");
      option6 = document.getElementById("column");
      option7 = document.getElementById("field");
      option8 = document.getElementById("operator");	 
     
// Show and hide the appropriate select's
     if (this.value == "Neopixel") {
     
       option1.style.display = "";
       option2.style.display = "";
       option3.style.display = "";
       option4.style.display = "";
       option5.style.display = "";
       option6.style.display = "none";
       option7.style.display = "none";
       option8.style.display = "none"; 
	   
     } else if (this.value == "Set AP Channel" || this.value == "Set Sleep Time" || this.value == "Set Mode" || this.value == "Digital Read" || this.value == "Analog Read") {
       
       option1.style.display = "";
       option2.style.display = "";
       option3.style.display = "none";
       option4.style.display = "none";
       option5.style.display = "none";
       option6.style.display = "none";
       option7.style.display = "none";
       option8.style.display = "none"; 
	   
	 } else if (this.value == "Digital Write" || this.value == "Analog Write" || this.value == "SELECT") {
       
       option1.style.display = "";
       option2.style.display = "";
       option3.style.display = "";
       option4.style.display = "none";
       option5.style.display = "none";
       option6.style.display = "none";
       option7.style.display = "none";  
       option8.style.display = "none";  
		  
  if (this.value == "SELECT") {
	 
	  option1.style.display = "none";
          option2.style.display = "none";
          option3.style.display = "none";
          option4.style.display = "none";
          option5.style.display = "none";
          option6.style.display = "";
          option7.style.display = "";
		  option8.style.display = ""; 
	   }
     } 
  };

  // Use the onchange and onkeypress events to detect when the 
  // value of select_command has changed
  attachEvent(select_command, "change", selectHandler);
  attachEvent(select_command, "keypress", selectHandler);
});

$(document).ready(function(){
  $("form").submit(function(){
    var sentCommand = document.getElementById('result').value;
    ws.send(sentCommand);  
   //alert("Submitted");
   //log('Sending: ' + sentCommand);
});
});

$(document).ready(function(){

$('.combine').on('change', function(){

if ($('#command').val() == "Set AP Channel" || "Set Sleep Time" || "Set Mode" || "Digital Read" || "Analog Read")
  { 
  var payload = $('#command').val() + '/' + $('#device').val() + '/' + $('#command1').val(); 
  }  

if ($('#command').val() == "Digital Write")
    {
    var payload = $('#command').val() + '/' + $('#device').val() + '/' + $('#command1').val() + "/" + $('#command2').val(); 
    }
if ($('#command').val() == "SELECT")
    {
    var payload = $('#command').val() + " " + $('#column').val() + " FROM test1 WHERE " + $('#field').val() +  " " + $('#operator').val() + " 'Enter your choice'"; 
    }
	
$('#result').val(payload); 
   });
})
</script>

<br>
<input type="text" id="result" size = "52" name="send" value="" />
<input type="submit" value="Send Command">

</form>

<textarea rows="4" cols="35" id="display" value="" spellcheck="false"  readonly="true" style="font-size:16px;line-height: 1em;">
</textarea>

<!--<p><input id="sentMessage" type="text" size="40" value="06/06/">
<button onclick="sendText()">Send Command or SQL</button></p>
<ul id="receivedMessage">Commands & Messages received from server appear below 
</ul>  -->

<script type='text/javascript'>

if ("WebSocket" in window) {

//var ws = new WebSocket ("ws://192.168.0.9:80/ws"); 

var ws = new WebSocket ("ws://" + window.location.hostname + ":80/ws"); 

// ----- send text data -----
function sendText() {
var sentMessage = document.getElementById('sentMessage').value;
//log('Sending: ' + sentMessage);
ws.send(sentMessage);
}

ws.onopen = function () {
       /*
          // ----- send text data -----

          ws.send ("Hello webSocket server, after this text I'm sending 32 16 bit binary integers."); 

          // ----- send binary data -----

          const fibonacciSequence = new Uint16Array (32);
          fibonacciSequence [0] = -21;
          fibonacciSequence [1] = 13;
          for (var i = 2; i < 32; i ++) fibonacciSequence [i] = fibonacciSequence [i - 1] + fibonacciSequence [i - 2]; 
          ws.send (fibonacciSequence);
       */
	   };
       
ws.onmessage = function (evt) {
  
    if (typeof(evt.data) === 'string' || evt.data instanceof String) { // UTF-8 formatted string data
        
    // ----- receive text data -----
        //log('Received from server ' + evt.data);
        //alert ("Got text from server over webSocket: " + evt.data);
        display.value += event.data + "\n";
		
        var textarea = document.getElementById('messages');
        //data = '['+event.data.replace(/,/g, '],.')+']';
        //data = data.replace(/./g, '[');		
	//console.log(JSON.parse(data)); // See https://stackoverflow.com/questions/54511538/convert-string-into-an-array-of-arrays-in-javascript
	//data = evt.data.replace(',',''); // Remove first comma.
	data = Function('return [' +  evt.data + ']')(); 
	console.log(data);
		
	var title = "Environment data from sensor network";
	const opts = {
         title: title,
         width: 360,
         height: 640,
         hooks: {
  	     ready: [
    	 u => {
      	 let legend = u.root.querySelector(".u-legend");
        
         legend.addEventListener("contextmenu", e => {
            e.preventDefault();

            let seriesEl = e.target.closest(".u-series");
          
            let seriesIdx = Array.prototype.slice.call(legend.childNodes).indexOf(seriesEl);
          
            let series = u.series[seriesIdx];
          
            console.log(series.label);
        });
      }
    ],
  },
  scales: {
    x: {
      time: true,
    }
  },
  series: [
    {},
    {
      label: "Location",
      stroke: "purple",
      fill: "rgba(0,0,255,0.2)",
    },
    {
      label: "V",
      stroke: "olive",
      fill: "rgba(0,0,255,0.2)",
    },
    {
      label: "S",
      stroke: "orange",
      fill: "rgba(0,0,255,0.2)",
    },
    {
      label: "T",
      stroke: "blue",
      fill: "rgba(0,0,255,0.2)",
    },
    {
      label: "H",
      stroke: "red",
      fill: "rgba(255,0,0,0.2)",
    },
    {
      label: "P",
      stroke: "green",
      fill: "rgba(0,0,255,0.2)",
    },
    {
      label: "L",
      stroke: "yellow",
      fill: "rgba(255,0,0,0.2)",
    },
  ],
};


let u = new uPlot(opts, data, document.body);
}		
 
 if (evt.data instanceof Blob) { // binary data

// ----- receive binary data as blob and then convert it into array buffer -----

var myFloat32Array = null;
var myArrayBuffer = null;
var myFileReader = new FileReader ();

myFileReader.onload = function (event) {
              myArrayBuffer = event.target.result;
              myFloat32Array = new Float32Array (myArrayBuffer); // <= our data is now here, in the array of 32 bit floating point numbers

var myMessage = "Got " + myArrayBuffer.byteLength + " bytes of binary data from server over webSocket\n[example 10]";
for (var i = 0; i < myFloat32Array.length; i++) myMessage += " " + myFloat32Array [i];
//alert (myMessage);
                
ws.close (); // this is where webSocket connection ends - in our simple "protocol" browser closes the connection but it could be the server as well
 };
myFileReader.readAsArrayBuffer (evt.data);
 }
 
};
				
ws.onclose = function () { 
//alert ("WebSocket connection is closed."); 
  };
} else {
        alert ("WebSockets are not supported by your browser.");
        }

</script>
<script>

// converts the legend into a simple tooltip
function legendAsTooltipPlugin({ className, style = { backgroundColor:"rgba(255, 249, 196, 0.92)", color: "black" } } = {}) {
				let legendEl;

				function init(u, opts) {
					legendEl = u.root.querySelector(".u-legend");

					legendEl.classList.remove("u-inline");
					className && legendEl.classList.add(className);

					uPlot.assign(legendEl.style, {
						textAlign: "left",
						pointerEvents: "",
						display: "none",
						position: "absolute",
						left: 0,
						top: 0,
						zIndex: 100,
						boxShadow: "2px 2px 10px rgba(0,0,0,0.5)",
						...style
					});

					// hide series color markers
					const idents = legendEl.querySelectorAll(".u-marker");

					for (let i = 0; i < idents.length; i++)
						idents[i].style.display = "";

					const overEl = u.root.querySelector(".u-over");
					overEl.style.overflow = "visible";

					// move legend into plot bounds
					overEl.appendChild(legendEl);

					// show/hide tooltip on enter/exit
					overEl.addEventListener("mouseenter", () => {legendEl.style.display = null;});
					overEl.addEventListener("mouseleave", () => {legendEl.style.display = "none";});

					// let tooltip exit plot
				//	overEl.style.overflow = "visible";
				}

				function update(u) {
					const { left, top } = u.cursor;
					legendEl.style.transform = "translate(" + left + "px, " + top + "px)";
				}

				return {
					hooks: {
						init: init,
						setCursor: update,
					}
				};
			}

			function prepData(packed) {
				console.time("prep");

				// epoch,location,voltage,rssi,temperature,humidity,pressure,light

				const numFields = packed[0];
                console.log(numFields); //8
				packed = packed.slice(numFields + 1);
                console.log(packed); //single array array of all sensor data(344)
				
				let data = [
					Array(packed.length/numFields), // epoch
					Array(packed.length/numFields), // location
                                        Array(packed.length/numFields), // voltage
					Array(packed.length/numFields), // rssi
					Array(packed.length/numFields), // temp
					Array(packed.length/numFields), // humidity
					Array(packed.length/numFields), // pressure
					Array(packed.length/numFields), // light
					//Array(packed.length/numFields), // location
				];
				
			    console.log(data); // (8)arrays of values by sensor type

				for (let i = 0, j = 0; i < packed.length; i += numFields, j++) {
					//data[2][j] = round2(100 * packed[i+5] / (packed[i+5] + packed[i+6]));
					data[0][j] = packed[i+0];
					data[1][j] = packed[i+1];
					data[2][j] = packed[i+2];
					data[3][j] = packed[i+3];
					data[4][j] = packed[i+4];
					data[5][j] = packed[i+5];
					data[6][j] = packed[i+6] * 4;
					data[7][j] = packed[i+7];
				}

			/*
				function filter(d) {
					return d.filter((d, i) => Math.round(i/1000) % 5 != 2);
				}

				data[0] = filter(data[0]);
				data[1] = filter(data[1]);
				data[2] = filter(data[2]);
				data[3] = filter(data[3]);
			*/
			/*
				data[0] = data[0].slice(0, 1000);
				data[1] = data[1].slice(0, 1000);
				data[2] = data[2].slice(0, 1000);
				data[3] = data[3].slice(0, 1000);

				data[1][35] = null;
				data[1][36] = null;
				data[2][730] = null;
			*/
				console.timeEnd("prep");

				return data;
				console.log(data);
			}


			function makeChart(data) {
				console.time("chart");

		
		var title = "Environment data from sensor network";
		const opts = {
					title: title,
					
					width: 640,
					height: 480,
				//	ms:     1,
				//	cursor: {
				//		x: false,
				//		y: false,
				//	},
					series: [
						{},
						{
							label: "Location",
							scale: "",
							value: (u, v) => v == null ? "-" : v.toFixed(2) + " ",
							stroke: "teal",
							width: 1/devicePixelRatio,
						},
						{
							label: "Voltage",
							scale: "F",
							value: (u, v) => v == null ? "-" : v.toFixed(2) + " V",
							stroke: "green",
							width: 1/devicePixelRatio,
						},
						{
							label: "RSSI",
							scale: "F",
							value: (u, v) => v == null ? "-" : v.toFixed(2) + "",
							stroke: "maroon",
							width: 1/devicePixelRatio,
						},
						{
							label: "Temperature",
							scale: "F",
							value: (u, v) => v == null ? "-" : v.toFixed(2) + " F�",
							stroke: "lime",
							width: 1/devicePixelRatio,
						},
						{
							label: "Humidity",
							scale: "%",
							value: (u, v) => v == null ? "-" : v.toFixed(1) + " %",
							stroke: "olive",
							width: 1/devicePixelRatio,
						},
						{
							label: "Pressure",
							scale: "mb",
							value: (u, v) => v == null ? "-" : v.toFixed(2) + " mb",
							stroke: "blue",
							width: 1/devicePixelRatio,
						},
						{
							label: "Light",
							scale: "%",
							value: (u, v) => v == null ? "-" : v.toFixed(2) + " %",
							stroke: "orange",
							width: 1/devicePixelRatio,
						}
					],
					
					plugins: [
					
					legendAsTooltipPlugin()
					
				],
					
					axes: [
						{},
						{
							scale: "",
							values: (u, vals, space) => vals.map(v => +v.toFixed(1) + " "),
						},
						{
							side: 1,
							scale: "F",
							size: 60,
							values: (u, vals, space) => vals.map(v => +v.toFixed(2) + ""),
							grid: {show: false},
						},
					],
				};
              
				let uplot = new uPlot(opts, data, document.body);
        
				Promise.resolve().then(() => {
					
					console.timeEnd("chart");
				});
			}

			fetch("data.json").then(r => r.json()).then(packed => {
				
				let data = prepData(packed);
				setTimeout(() => makeChart(data), 0);
			});
</script>
</body>
</html>b
